# =============================================================================
# CI/CD WORKFLOW FOR PLAYWRIGHT API TESTS WITH SYLIUS STANDARD
# =============================================================================
#
# ARCHITECTURE:
# -------------
# This workflow demonstrates a common CI/CD pattern: cloning an application,
# provisioning it with Docker Compose, and running automated tests against it.
#
#   ┌─────────────────────────────────────────────────────────────────┐
#   │                    GITHUB ACTIONS RUNNER                        │
#   │                                                                 │
#   │  ┌──────────────────────┐    ┌──────────────────────┐          │
#   │  │  QA AUTOMATION REPO  │    │  SYLIUS STANDARD     │          │
#   │  │  (this repo)         │    │  (cloned in CI)      │          │
#   │  │                      │    │                      │          │
#   │  │  - Playwright tests  │    │  - PHP/Symfony app   │          │
#   │  │  - Test data         │    │  - Docker Compose    │          │
#   │  │  - API clients       │    │  - Fixtures          │          │
#   │  └──────────────────────┘    └──────────────────────┘          │
#   │           │                           │                        │
#   │           │         DOCKER NETWORK    │                        │
#   │           │    ┌──────────────────────┴───────┐                │
#   │           │    │  nginx:80 ◄── php ◄── mysql  │                │
#   │           │    └──────────────────────────────┘                │
#   │           │                    ▲                               │
#   │           └────────────────────┘                               │
#   │              Tests connect to localhost:80                     │
#   └─────────────────────────────────────────────────────────────────┘
#
# KEY CI/CD CONCEPTS DEMONSTRATED:
# --------------------------------
# 1. TRIGGERS (on): push, pull_request, workflow_dispatch
# 2. DOCKER COMPOSE: Multi-container orchestration
# 3. HEALTH CHECKS: Wait for services to be ready
# 4. FIXTURES: Load consistent test data
# 5. ARTIFACTS: Save test reports
# 6. CLEANUP: Always stop containers
#
# =============================================================================

name: Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ========================================================================
      # PHASE 1: SETUP REPOSITORIES
      # ========================================================================

      - name: Checkout test repository
        uses: actions/checkout@v4
        with:
          path: tests

      - name: Clone Sylius Standard
        run: git clone --depth 1 https://github.com/Sylius/Sylius-Standard.git sylius

      # ========================================================================
      # PHASE 2: CONFIGURE AND START DOCKER SERVICES
      # ========================================================================

      - name: Create Docker Compose override for CI
        working-directory: sylius
        run: |
          if [ -f compose.override.yml.dist ]; then
            cp compose.override.yml.dist compose.override.yml
            sed -i 's/APP_DEBUG: 0/APP_DEBUG: 1/g' compose.override.yml || true
          else
            echo 'services:'                                      > compose.override.yml
            echo '  php:'                                        >> compose.override.yml
            echo '    volumes:'                                  >> compose.override.yml
            echo '      - .:/srv/sylius:rw'                      >> compose.override.yml
            echo '      - ./public:/srv/sylius/public:rw'        >> compose.override.yml
            echo '    environment:'                              >> compose.override.yml
            echo '      APP_ENV: dev'                            >> compose.override.yml
            echo '      APP_DEBUG: "1"'                          >> compose.override.yml
            echo '      DATABASE_URL: "mysql://root@mysql/sylius_dev"' >> compose.override.yml
            echo '  nginx:'                                      >> compose.override.yml
            echo '    depends_on:'                               >> compose.override.yml
            echo '      php:'                                    >> compose.override.yml
            echo '        condition: service_started'            >> compose.override.yml
            echo '    volumes:'                                  >> compose.override.yml
            echo '      - ./public:/srv/sylius/public:ro'        >> compose.override.yml
            echo '    ports:'                                    >> compose.override.yml
            echo '      - "80:80"'                               >> compose.override.yml
            echo '  mysql:'                                      >> compose.override.yml
            echo '    ports:'                                    >> compose.override.yml
            echo '      - "3306:3306"'                           >> compose.override.yml
          fi

      - name: Start Docker services
        working-directory: sylius
        run: docker compose -f compose.yml -f compose.override.yml up -d

      - name: Wait for MySQL
        working-directory: sylius
        run: |
          echo "Waiting for MySQL to be ready..."
          timeout 120 bash -c 'until docker compose -f compose.yml -f compose.override.yml exec -T mysql mysqladmin ping -h localhost --silent; do
            sleep 5
          done'
          echo "MySQL is ready!"

      # ========================================================================
      # PHASE 3: INSTALL DEPENDENCIES AND CONFIGURE APPLICATION
      # ========================================================================

      - name: Install Composer dependencies
        working-directory: sylius
        run: docker compose -f compose.yml -f compose.override.yml exec -T php composer install --no-interaction --prefer-dist

      - name: Setup database and load fixtures
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console doctrine:database:create --if-not-exists
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console doctrine:migrations:migrate --no-interaction
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console sylius:fixtures:load --no-interaction

      - name: Generate JWT keys for API authentication
        working-directory: sylius
        run: docker compose -f compose.yml -f compose.override.yml exec -T php bin/console lexik:jwt:generate-keypair --skip-if-exists

      - name: Grant API access to admin user
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console doctrine:query:sql \
            "UPDATE sylius_admin_user SET roles = '[\"ROLE_ADMINISTRATION_ACCESS\", \"ROLE_API_ACCESS\"]' WHERE username = 'sylius'"

      - name: Configure Symfony environment
        working-directory: sylius
        run: |
          echo "APP_ENV=dev" > .env.local
          echo "APP_DEBUG=1" >> .env.local
          echo "APP_SECRET=ThisIsASecretForCI12345" >> .env.local
          echo "DATABASE_URL=mysql://root@mysql/sylius_dev" >> .env.local
          echo "MAILER_DSN=null://null" >> .env.local
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console cache:clear --env=dev || true
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console assets:install public --env=dev

      # ========================================================================
      # PHASE 4: VERIFY APPLICATION IS READY
      # ========================================================================

      - name: Wait for Nginx and verify Sylius
        run: |
          echo "Waiting for Sylius to be ready..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "301" ]; then
              echo "✅ Sylius is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/30: HTTP $HTTP_CODE - Waiting..."
            sleep 3
          done
          echo "❌ Sylius did not become ready in time"
          exit 1

      # ========================================================================
      # PHASE 5: RUN PLAYWRIGHT TESTS
      # ========================================================================

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Install Playwright browsers
        working-directory: tests
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: tests
        run: npx playwright test
        env:
          CI: true

      # ========================================================================
      # PHASE 6: ARTIFACTS AND CLEANUP
      # ========================================================================

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: tests/playwright-report/
          retention-days: 30

      - name: Show logs on failure
        if: failure()
        working-directory: sylius
        run: |
          echo "=== PHP Logs ==="
          docker compose -f compose.yml -f compose.override.yml logs php --tail=50
          echo "=== Nginx Logs ==="
          docker compose -f compose.yml -f compose.override.yml logs nginx --tail=50

      - name: Cleanup Docker
        if: always()
        working-directory: sylius
        run: docker compose -f compose.yml -f compose.override.yml down --volumes
