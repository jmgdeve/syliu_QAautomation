# =============================================================================
# CI/CD WORKFLOW FOR PLAYWRIGHT TESTS WITH SYLIUS STANDARD
# =============================================================================
#
# ARCHITECTURE:
# -------------
# This workflow clones Sylius Standard, starts it with Docker Compose,
# then runs our Playwright tests against it.
#
#   ┌─────────────────────────────────────────────────────────────────┐
#   │                    GITHUB ACTIONS RUNNER                        │
#   │                                                                 │
#   │  ┌──────────────────────┐    ┌──────────────────────┐          │
#   │  │  QA AUTOMATION REPO  │    │  SYLIUS STANDARD     │          │
#   │  │  (this repo)         │    │  (cloned in CI)      │          │
#   │  │                      │    │                      │          │
#   │  │  - Playwright tests  │    │  - PHP app           │          │
#   │  │  - Test data         │    │  - Docker Compose    │          │
#   │  │  - API clients       │    │  - Fixtures          │          │
#   │  └──────────────────────┘    └──────────────────────┘          │
#   │           │                           │                        │
#   │           │         DOCKER NETWORK    │                        │
#   │           │    ┌──────────────────────┴───────┐                │
#   │           │    │  nginx:80 ◄── php ◄── mysql  │                │
#   │           │    └──────────────────────────────┘                │
#   │           │                    ▲                               │
#   │           └────────────────────┘                               │
#   │              Tests connect to localhost:80                     │
#   └─────────────────────────────────────────────────────────────────┘
#
# =============================================================================

name: Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ========================================================================
      # STEP 1: CHECKOUT TEST REPOSITORY (this repo)
      # ========================================================================
      - name: Checkout test repository
        uses: actions/checkout@v4
        with:
          path: tests

      # ========================================================================
      # STEP 2: CLONE SYLIUS STANDARD
      # ========================================================================
      # ARCHITECTURE CONCEPT: Separation of Concerns
      # - Test code lives in THIS repo
      # - Application code lives in Sylius Standard
      # - CI brings them together temporarily
      # ========================================================================
      - name: Clone Sylius Standard
        run: |
          git clone --depth 1 https://github.com/Sylius/Sylius-Standard.git sylius
          cd sylius
          git log --oneline -1

      # ========================================================================
      # STEP 3: CREATE DOCKER COMPOSE OVERRIDE FOR CI
      # ========================================================================
      # The Sylius Standard repo has compose.override.yml.dist (template)
      # We need to create compose.override.yml with volume mounts for CI
      # ========================================================================
      - name: Create Docker Compose override for CI
        working-directory: sylius
        run: |
          # Copy the dist file if it exists, otherwise create minimal override
          if [ -f compose.override.yml.dist ]; then
            echo "Using compose.override.yml.dist as base"
            cp compose.override.yml.dist compose.override.yml
          else
            echo "Creating minimal compose.override.yml"
            # Create minimal override with volume mounts
            cat > compose.override.yml << 'EOF'
          services:
            php:
              volumes:
                - .:/srv/sylius:rw
                - ./public:/srv/sylius/public:rw
              environment:
                APP_ENV: dev
                APP_DEBUG: 0
                DATABASE_URL: "mysql://root@mysql/sylius_dev"
            nginx:
              depends_on:
                php:
                  condition: service_started
              volumes:
                - ./public:/srv/sylius/public:ro
              ports:
                - "80:80"
            mysql:
              ports:
                - "3306:3306"
          EOF
          fi
          echo "=== compose.override.yml contents ==="
          cat compose.override.yml

      # ========================================================================
      # STEP 4: START SYLIUS WITH DOCKER COMPOSE
      # ========================================================================
      - name: Start Sylius with Docker Compose
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml up -d
          echo "Docker containers starting..."

      # ========================================================================
      # STEP 4: WAIT FOR MYSQL TO BE HEALTHY
      # ========================================================================
      - name: Wait for MySQL
        working-directory: sylius
        run: |
          echo "Waiting for MySQL..."
          timeout 120 bash -c 'until docker compose -f compose.yml -f compose.override.yml exec -T mysql mysqladmin ping -h localhost --silent; do
            echo "Waiting for MySQL..."
            sleep 5
          done'
          echo "MySQL is ready!"

      # ========================================================================
      # STEP 5: INSTALL COMPOSER DEPENDENCIES
      # ========================================================================
      - name: Install Composer dependencies
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php composer install --no-interaction --prefer-dist

      # ========================================================================
      # STEP 6: SETUP DATABASE AND FIXTURES
      # ========================================================================
      # ARCHITECTURE CONCEPT: Test Data Management
      # - Create database schema
      # - Load fixtures (products, channels, users)
      # - Creates consistent starting state for tests
      # ========================================================================
      - name: Setup database and load fixtures
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console doctrine:database:create --if-not-exists
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console doctrine:migrations:migrate --no-interaction
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console sylius:fixtures:load --no-interaction
          echo "Database and fixtures ready!"

      # ========================================================================
      # STEP 7: CREATE QA ADMIN USER
      # ========================================================================
      # Creates admin user matching testData.ts credentials
      # ========================================================================
      - name: Create QA admin user
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console sylius:user:create \
            qa@example.com sylius123 QA Admin en_US --admin || echo "User may already exist"
          echo "QA admin user ready!"

      # ========================================================================
      # STEP 8: INSTALL ASSETS (skip frontend build for API testing)
      # ========================================================================
      # NOTE: We skip yarn build because:
      # - Our tests are API-only (no browser UI testing)
      # - The nodejs service requires additional setup
      # - API endpoints work without compiled frontend
      # ========================================================================
      - name: Install Symfony assets
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml exec -T php bin/console assets:install public
          echo "Assets installed!"

      # ========================================================================
      # STEP 9: CHECK DOCKER STATUS AND WAIT FOR NGINX
      # ========================================================================
      - name: Check Docker containers status
        working-directory: sylius
        run: |
          echo "=== Docker containers status ==="
          docker compose -f compose.yml -f compose.override.yml ps
          echo ""
          echo "=== Nginx logs ==="
          docker compose -f compose.yml -f compose.override.yml logs nginx || true
          echo ""
          echo "=== PHP logs ==="
          docker compose -f compose.yml -f compose.override.yml logs php || true

      - name: Wait for Nginx
        run: |
          echo "Waiting for Nginx..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200\|302\|301"; then
              echo "Sylius is ready at http://localhost!"
              exit 0
            fi
            echo "Attempt $i: Waiting for web server..."
            sleep 5
          done
          echo "ERROR: Nginx did not respond after 30 attempts"
          echo "=== Final curl attempt with verbose ==="
          curl -v http://localhost || true
          exit 1

      # ========================================================================
      # STEP 10: SETUP NODE.JS FOR PLAYWRIGHT
      # ========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      # ========================================================================
      # STEP 11: INSTALL TEST DEPENDENCIES
      # ========================================================================
      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      # ========================================================================
      # STEP 12: INSTALL PLAYWRIGHT BROWSERS
      # ========================================================================
      - name: Install Playwright browsers
        working-directory: tests
        run: npx playwright install --with-deps chromium

      # ========================================================================
      # STEP 13: RUN PLAYWRIGHT TESTS
      # ========================================================================
      - name: Run Playwright tests
        working-directory: tests
        run: npx playwright test
        env:
          CI: true

      # ========================================================================
      # STEP 14: UPLOAD TEST REPORT
      # ========================================================================
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: tests/playwright-report/
          retention-days: 30

      # ========================================================================
      # STEP 15: SHOW LOGS ON FAILURE
      # ========================================================================
      - name: Show Docker logs on failure
        if: failure()
        working-directory: sylius
        run: |
          docker compose -f compose.yml -f compose.override.yml logs php
          docker compose -f compose.yml -f compose.override.yml logs nginx
          docker compose -f compose.yml -f compose.override.yml logs mysql

      # ========================================================================
      # STEP 16: CLEANUP
      # ========================================================================
      - name: Cleanup Docker
        if: always()
        working-directory: sylius
        run: docker compose -f compose.yml -f compose.override.yml down --volumes

# =============================================================================
# EXPECTED TIMELINE (first run):
# =============================================================================
# - Clone repos: ~30s
# - Docker pull: ~3-5 min (cached after first run)
# - Composer install: ~2-3 min
# - Fixtures + assets: ~2-3 min
# - Playwright install: ~1 min
# - Tests: ~1-2 min
# - Total: ~10-15 min (first run), ~5-8 min (cached)
# =============================================================================
